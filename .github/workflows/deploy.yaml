name: deploy
on:
  push:
    branches: [staging, production]
  pull_request:
    branches: [staging]
permissions:
  contents: read
  pull-requests: write
  deployments: write
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true
jobs:
  deploy-staging:
    if: github.ref == 'refs/heads/staging' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
      - name: bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3
        with:
          bun-version: 1.3.9
      - name: install
        run: bun install
      - name: migrate
        run: bun run db:migrate:staging
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      - name: build
        run: bun run build:staging
      - name: upload version
        run: bun run wrangler versions upload
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

  deploy-production:
    if: github.ref == 'refs/heads/production' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
      - name: bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3
        with:
          bun-version: 1.3.9
      - name: install
        run: bun install
      - name: migrate
        run: bun run db:migrate:prod
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      - name: build
        run: bun run build
      - name: deploy
        run: bun run wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

  preview:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
      - name: bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3
        with:
          bun-version: 1.3.9
      - name: install
        run: bun install
      - name: build
        run: bun run build:staging
      - name: upload version
        id: upload
        run: |
          OUTPUT=$(bun run wrangler versions upload 2>&1)
          echo "$OUTPUT"
          VERSION_ID=$(echo "$OUTPUT" | grep -oP 'Worker Version ID:\s+\K[a-f0-9-]+')
          echo "version_id=$VERSION_ID" >> "$GITHUB_OUTPUT"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      - name: comment preview url
        if: steps.upload.outputs.version_id != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          VERSION_ID: ${{ steps.upload.outputs.version_id }}
        run: |
          gh pr comment "$PR_NUMBER" --body "Preview version uploaded to **affirm** worker (staging D1).

          **Version ID:** \`$VERSION_ID\`

          Preview URL available in the [Cloudflare dashboard](https://dash.cloudflare.com/) under Workers > affirm > Versions."
